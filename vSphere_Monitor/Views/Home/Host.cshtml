@{
    ViewBag.Title = "Index";
}

<div class="jumbotron">
    <h1 id="host">ESXi @ViewBag.HostID</h1>
</div>

<div class="row">
    <div class="col-md-4">
        <h2>Consommation CPU</h2>
        <div class="rectangleEmpty">
            <div id="cpu"></div>
        </div>
    </div>
    <div class="col-md-4">
        <h2>Consommation RAM</h2>
        <div class="rectangleEmpty">
            <div id="ram" class="rectangleOrange"></div>
        </div>
    </div>
    <div class="col-md-4">
        <h2>Stockage</h2>
        <div class="rectangleEmpty">
            <div id="storage" class="rectangleRed"></div>
        </div>
    </div>
</div>

<div class="row">
    <h2 class="text-center">Machines virtuelles</h2>
</div>

<div class="row" id="vm">
</div>

@section scripts {
    <script>
        function update() {
            // Using the core $.ajax() method
            $.ajax({

                // The URL for the request
                url: '@Url.Action("RunPowershell", "Home")',

                // The data to send (will be converted to a query string)
                // format = name of value : value
                data: {
                    hostId: "@ViewBag.HostID",
                },

                // Whether this is a POST or GET request
                type: "POST",

                // The type of data we expect back
                dataType: "json",
            })
                // Code to run if the request succeeds (is done);
                // The response is passed to the function
                .done(function (data) {
                    var host = data[0];
                    console.log(host);

                    $('#host').append(' - ' + host.Adress);

                    var percentage = 100;
                    var division = host.Cpu_usage / host.Cpu_total;
                    var result = division * percentage;

                    console.log(percentage);
                    console.log(division);
                    console.log(result);

                    if ((host.Cpu_usage / host.Cpu_total) * 100 <= 80) {
                        $('#cpu').addClass('rectangleGreen');
                        $('#cpu').width((host.Cpu_usage / host.Cpu_total) * 300);
                    }
                    //$('#cpu').append(' - ' + host.Adress);
                    //$('#ram').append(' - ' + host.Adress);
                    //$('#stor').append(' - ' + host.Adress);

                    $.each(host.Vms, function (k, v) {
                        var vm = $(this)[0];
                        $('#vm').append('<div class="col"><p> Nom : ' + vm.Name + '</p> <p> Nombre de CPU : ' + vm.Cpu_number + '</p> <p> Mémoire : ' + vm.Memory + '</p></div>');
                        console.log(vm);
                    });
                })
            // Code to run if the request fails; the raw request and
            // status codes are passed to the function
                .fail(function( xhr, status, errorThrown ) {
                    alert( "Sorry, there was a problem!" );
                    console.log( "Error: " + errorThrown );
                    console.log( "Status: " + status );
                    console.dir( xhr );
                })
        }
        //automatic ajax call every 5 seconds
        //setInterval(function () {
        //    update();
        //}, 5000);

        $(document).ready(function () {
            update();
        })
    </script>
}